# 要件定義書: CodeContext (Draft 1/3)

## 1. プロジェクト概要

### 1.1. プロジェクト名

**CodeContext** (仮称)

### 1.2. 目的

本プロジェクトは、ソースコードの構造と文脈を「人間」と「AI (LLM)」の両方が効率的に理解できる形にするための VS Code 拡張機能を開発することを目的とする。

* **対 人間:** 複雑なコードの依存関係（ファイル、クラス、関数）をグラフとして可視化し、デバッグやコードリーディング時の認知負荷を下げる。
* **対 LLM (将来構想):** RAG (Retrieval-Augmented Generation) の精度向上のため、コードの「意味（要約）」と「構造（グラフ）」をセットにしたコンテキストを提供する基盤を作る。

### 1.3. フェーズ定義

本要件定義書では、**Phase 1: MVP (Minimum Viable Product)** の仕様を定義する。

* **Phase 1 (今回):** Pythonコードの静的解析、グラフデータベース(CozoDB)への格納、Cytoscape.jsによる可視化。**LLM連携（要約・ベクトル化）は実装しない。**
* **Phase 2 (将来):** LLMによる要約生成、ベクトル検索、GraphRAG実装。
* **Phase 3 (将来):** 他言語対応、マルチモーダル対応。

## 2. システムアーキテクチャ

本拡張機能は、VS Code の拡張機能アーキテクチャに基づき、以下の2つのプロセスで構成される。

### 2.1. Extension Host (バックエンド / TypeScript)

Node.js 環境で動作するメインプロセス。

* **責務:** 拡張機能のライフサイクル管理、ファイルシステム操作、解析ロジック実行、データベース操作。
* **構成技術:**
* Runtime: Node.js (VS Code内蔵)
* Language: TypeScript
* Parser: `web-tree-sitter` (Wasm版) + `tree-sitter-python`
* Database: `cozo-lib-wasm` (インメモリ動作 + ファイルダンプ)



### 2.2. Webview (フロントエンド / UI)

VS Code 内の独立したブラウザ環境で動作するUIプロセス。

* **責務:** グラフの描画、ユーザーインタラクションの受け付け、検索UIの提供。
* **構成技術:**
* Framework: React
* Visualization: `Cytoscape.js`
* Bundler: Webpack or Vite



### 2.3. データ永続化

* 解析データは実行中はメモリ上（CozoDB In-Memory）に保持する。
* 永続化のため、プロジェクトルート直下の `.code-context/` ディレクトリにDBのダンプファイルまたはJSONを保存・読み込みを行う。

## 3. 機能要件 (バックエンド / ロジック)

### 3.1. アクティベーションと初期化

* **REQ-B-01 (オンデマンド起動):**
* 拡張機能は VS Code 起動時にはバックグラウンド処理を行わない。
* ユーザーがコマンド `CodeContext: Open Graph` を実行した時点でアクティベーション（起動）する。


* **REQ-B-02 (データロード):**
* 起動時、`.code-context/db_dump` が存在すれば CozoDB にインポートする。
* 存在しない場合は、新規に空のDBを作成する。



### 3.2. ソースコード解析 (Parser)

* **REQ-B-03 (対象言語):**
* MVPでは `.py` ファイルのみを解析対象とする。


* **REQ-B-04 (除外設定):**
* `.gitignore` ファイルを尊重し、除外されているファイルはスキャンしない。
* 将来的に `.llmignore` をサポート可能な設計とする。


* **REQ-B-05 (解析粒度):**
* `web-tree-sitter` を使用し、以下のシンボルを抽出する。
1. **File:** ファイルパス
2. **Class:** クラス定義（開始行・終了行）
3. **Function/Method:** 関数定義（開始行・終了行）、所属クラス


* 以下の関係性（エッジ）を抽出する。
1. **Import:** `import A`, `from A import B` の依存関係
2. **Call (簡易):** 関数内での他の関数呼び出し（※静的解析で特定可能な範囲に限る）
3. **Contains:** ファイル→クラス→メソッド の包含関係





### 3.3. データベース操作 (CozoDB)

* **REQ-B-06 (データ格納):**
* 解析結果を Datalog 形式のデータ（Facts）に変換し、CozoDB に `put` する。
* 再スキャン時は、更新があったファイルに関連する古いデータを削除してから挿入する（Upsert/Replace）。


* **REQ-B-07 (データ保存):**
* 以下のタイミングでメモリ上のDBを `.code-context/db_dump` に書き出す。
1. Webview上の「保存」ボタン押下時。
2. (オプション) 拡張機能の非アクティブ化時。




* **REQ-B-08 (クエリインターフェース):**
* フロントエンドからの要求に応じ、以下の Datalog クエリを実行するAPIを提供する。
1. 全ノード・エッジの取得（初期表示用）
2. 特定ノードに隣接するノードの取得（ドリルダウン用）
3. ファイルパスによるノード検索